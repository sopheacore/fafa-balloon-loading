<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Balloon Loading Game v1.1</title>
  <link rel="icon" href="./assets/hot-air-balloon.ico" type="image/x-icon" />

  <!-- Meta Pixel Code -->
  <script>
  !function(f,b,e,v,n,t,s)
  {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};
  if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
  n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];
  s.parentNode.insertBefore(t,s)}(window, document,'script',
  'https://connect.facebook.net/en_US/fbevents.js');
  fbq('init', '2023003695132367');
  fbq('track', 'PageView');
  </script>
  <noscript><img height="1" width="1" style="display:none"
  src="https://www.facebook.com/tr?id=2023003695132367&ev=PageView&noscript=1"
  /></noscript>
  <!-- End Meta Pixel Code -->

  <style>
    :root { --vh: 100vh; }
    *{box-sizing:border-box}
    html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #000; }
    .landing { position: relative; width: 100vw; height: 100vh; overflow: hidden; -webkit-tap-highlight-color: transparent; }
    .landing-bg { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: contain; z-index: 0; }

    .headline { position: absolute; top: 4%; left: 50%; transform: translateX(-50%); z-index: 2; text-align:center; }
    .headline img { width: 72vw; max-width: 420px; height: auto; }

    .balloons {
      position: absolute; left: 50%; top: 55%; transform: translate(-50%, -50%);
      display: grid; grid-template-columns: repeat(4, clamp(72px, 20vw, 250px)); gap: min(4vw, 16px);
      z-index: 2; width: 92vw; max-width: 680px; justify-content: center; align-items: end;
      touch-action: manipulation;
    }

    .balloon {
      position: relative;
      width: clamp(72px, 20vw, 250px);
      height: clamp(72px, 20vw, 250px);
      background: center/contain no-repeat;
      filter: drop-shadow(0 6px 12px rgba(0,0,0,.25));
      cursor: pointer; transition: transform .22s ease;
      transform-origin: center center;
      -webkit-touch-callout: none; user-select: none;
    }

    .balloon::before { content:""; position:absolute; inset:-10%; }
    .balloon::after {
      content: ""; position: absolute; left: 50%; bottom: -14px; transform: translateX(-50%);
      width: 50%; height: 10px; background: radial-gradient(ellipse at center, rgba(0,0,0,.35), rgba(0,0,0,0));
      filter: blur(2px); pointer-events: none;
    }
    @media (hover:hover) and (pointer:fine){
      .balloon:hover { transform: translateY(-4px) scale(1.03); }
    }
    .balloon.disabled { pointer-events: none; }

    /* free-fly mode */
    .balloons.free-fly {
      position: absolute; inset: 0; transform: none; width: 100%; max-width: none; display: block;
    }
    .balloons.free-fly .balloon {
      position: absolute;
      left: var(--x, 10%);
      bottom: -20vh;
      animation-name: riseLoopDecel;
      animation-duration: var(--speed, 12s);
      animation-timing-function: linear;
      animation-iteration-count: infinite;
      animation-delay: var(--delay, 0s);
    }

    .play-button { position: absolute; left: 50%; transform: translateX(-50%); bottom: 22px; z-index: 2; display:none; }
    .play-button img, .action-button img { width: 320px; max-width: 82vw; height: auto; }

    .popup {
      position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center;
      background: rgba(0,0,0,.68); z-index: 3; opacity: 0; transform: scale(.9); pointer-events: none;
      -webkit-backdrop-filter: blur(2px); backdrop-filter: blur(2px);
    }
    .popup.show { pointer-events: auto; animation: popupIn .8s ease forwards; }
    .result { width: 360px; max-width: 92vw; margin-bottom: 14px; }
    .action-button { margin-top: 14px; }

    @keyframes popupIn { 0%{transform:scale(.9);opacity:0} 50%{transform:scale(1.05);opacity:1} 100%{transform:scale(1);opacity:1} }

    /* speed profile */
    @keyframes riseLoopDecel {
      0%   { transform: translateY(0) scale(1); opacity: 0; }
      5%   { opacity: 1; }
      25%  { transform: translateY(-31.6vh); }
      50%  { transform: translateY(-56.8vh); }
      75%  { transform: translateY(-82.1vh); }
      100% { transform: translateY(-120vh); opacity: 1; }
    }

    .balloon.scale-pop { animation: scalePop 0.7s ease-out forwards; z-index: 4; }
    @keyframes scalePop { 0% { transform: scale(1); } 100% { transform: scale(4); } }

    @media (max-height: 560px){ .balloons{ top:50%; } }
    @media (max-width: 600px) {
      .balloon { width: clamp(140px, 24vw, 275px); height: clamp(140px, 24vw, 275px); }
      .balloons { grid-template-columns: repeat(4, clamp(140px, 24vw, 275px)); }
    }
  </style>
</head>
<body>
  <div class="landing">
    <img class="landing-bg" src="./assets/BGnew.webp" alt="Background" />

    <!-- 🎈 Balloons -->
    <div class="balloons" id="balloons">
      <div class="balloon" style="background-image:url('./assets/B1.gif')" aria-label="balloon"></div>
      <div class="balloon" style="background-image:url('./assets/B2.gif')" aria-label="balloon"></div>
      <div class="balloon" style="background-image:url('./assets/B3.gif')" aria-label="balloon"></div>
      <div class="balloon" style="background-image:url('./assets/B1.gif')" aria-label="balloon"></div>
      <div class="balloon" style="background-image:url('./assets/B2.gif')" aria-label="balloon"></div>
      <div class="balloon" style="background-image:url('./assets/B3.gif')" aria-label="balloon"></div>
    </div>

    <!-- ▶️ Play CTA (kept but hidden) -->
    <div class="play-button"><img id="play-button" src="./assets/play bt.gif" alt="Play Now" /></div>

    <!-- 🔔 Popup -->
    <div class="popup" id="popup">
      <img class="result" id="resultImg" src="" alt="Result" />
      <div class="action-button" id="actionButton"></div>
    </div>
  </div>

  <!-- 🔊 SFX -->
  <audio id="sfx-pop"    src="./assets/sfx/pop.mp3"        preload="auto"></audio>
  <audio id="sfx-win"    src="./assets/sfx/win.mp3"        preload="auto"></audio>
  <audio id="sfx-lose"   src="./assets/sfx/lose.mp3"       preload="auto"></audio>
  <audio id="sfx-try"    src="./assets/sfx/try-again.mp3"  preload="auto"></audio>
  <audio id="sfx-claim"  src="./assets/sfx/claim.mp3"      preload="auto"></audio>

  <!-- 🎵 Background music -->
  <audio id="bgm" src="./assets/sfx/bgm.mp3" preload="auto" loop></audio>

  <!-- 🎉 Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

  <script>
    const balloonsWrap = document.getElementById('balloons');
    const playBtn = document.getElementById('play-button');
    const popup = document.getElementById('popup');
    const resultImg = document.getElementById('resultImg');
    const actionButton = document.getElementById('actionButton');

    // 🔊 Audio refs
    const sPop   = document.getElementById('sfx-pop');
    const sWin   = document.getElementById('sfx-win');
    const sLose  = document.getElementById('sfx-lose');
    const sTry   = document.getElementById('sfx-try');
    const sClaim = document.getElementById('sfx-claim');
    const bgm    = document.getElementById('bgm');

    // 🔉 v1.1 ducking: define base & ducked levels
    const BGM_BASE = 0.4;                         // normal intended bgm volume
    const BGM_DUCK = Number((BGM_BASE * 0.7).toFixed(2));  // -30% volume

    function playSfx(audioEl, volume = 1) {
      if (!audioEl) return;
      try {
        audioEl.pause();
        audioEl.currentTime = 0;
        audioEl.volume = volume;
        audioEl.play().catch(()=>{});
      } catch(e){}
    }

    // 🔉 v1.1 helper: smooth set volume (fade)
    function setBgmVolume(targetVol, fadeMs = 200) {
      if (!bgm) return;
      const startVol = bgm.volume ?? 0;
      if (fadeMs <= 0) { bgm.volume = targetVol; return; }
      const start = performance.now();
      function step(t) {
        const p = Math.min(1, (t - start) / fadeMs);
        bgm.volume = startVol + (targetVol - startVol) * p;
        if (p < 1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }

    // Smooth fade in for bgm (to a target)
    function fadeInBgm(targetVol = BGM_DUCK, ms = 1200) {
      if (!bgm) return;
      bgm.volume = 0;
      const start = performance.now();
      function step(t) {
        const p = Math.min(1, (t - start) / ms);
        bgm.volume = targetVol * p;
        if (p < 1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }

    // Autostart visuals + attempt silent bgm
    window.addEventListener('DOMContentLoaded', () => {
      if (playBtn) playBtn.style.display = 'none';
      startFreeFly();
      if (typeof fbq === 'function') fbq('trackCustom', 'Play', { content_name: 'Auto Start - Balloon' });
      try { bgm.volume = 0; bgm.play().catch(()=>{}); } catch(e){}
    }, { passive:true });

    // Unlock audio on first gesture and start bgm at DUCK level (-30%)
    let audioUnlocked = false;
    function unlockAudioOnce() {
      if (audioUnlocked) return;
      audioUnlocked = true;

      // tiny tick to satisfy policies
      playSfx(sPop, 0.001);
      setTimeout(()=>{
        try {
          bgm.currentTime = 0;
          bgm.loop = true;
          bgm.play().then(()=>{
            // 🔉 v1.1: start at ducked volume (−30%)
            fadeInBgm(BGM_DUCK, 1000);
          }).catch(()=>{});
        } catch(e){}
      }, 50);
    }
    window.addEventListener('pointerdown', unlockAudioOnce, { once:true, passive:true });

    // game state
    let playCount = 1;          // 1st click -> fail, 2nd click -> win
    let inputLocked = false;    // prevents multi-trigger/multi-touch

    function lockInput(){ inputLocked = true; }
    function unlockInput(){ inputLocked = false; }

    function showPopup() { popup.style.display = 'flex'; requestAnimationFrame(() => popup.classList.add('show')); }
    function hidePopup() { popup.classList.remove('show'); setTimeout(() => (popup.style.display = 'none'), 300); }

    function celebrateLoop() {
      let go = true;
      (function fire() {
        if (!go) return;
        if (typeof confetti === 'function') {
          confetti({ particleCount: 70, spread: 360, startVelocity: 42, ticks: 80, origin: { y: 0.55 } });
        }
        setTimeout(fire, 1800);
      })();
      actionButton.addEventListener('click', () => go = false, { once: true });
    }

    /* randomize helpers for free-fly mode */
    function seedBalloon(b) {
      const x = Math.random() * 80 + 10;                       // 10%..90%
      const speed = (Math.random() * 6 + 9).toFixed(2) + 's';  // 9s..15s
      const delay = (Math.random() * 3).toFixed(2) + 's';      // 0..3s
      b.style.setProperty('--x', x + '%');
      b.style.setProperty('--speed', speed);
      b.style.setProperty('--delay', delay);
    }
    function startFreeFly() {
      balloonsWrap.classList.add('free-fly');
      Array.from(balloonsWrap.querySelectorAll('.balloon')).forEach(b => {
        seedBalloon(b);
        b.addEventListener('animationiteration', () => {
          const x = Math.random() * 80 + 10;
          b.style.setProperty('--x', x + '%');
        }, { passive: true });
      });
    }

    // ===== Strict, accurate click handling =====
    balloonsWrap.addEventListener('pointerdown', (e) => {
      if (inputLocked || popup.classList.contains('show')) return;
      if (!e.isPrimary) return;

      const b = e.target.closest('.balloon');
      if (!b || b.classList.contains('disabled')) return;

      e.preventDefault();

      const startX = e.clientX, startY = e.clientY, pid = e.pointerId;

      const onPointerUp = (ev) => {
        if (ev.pointerId !== pid) return;
        window.removeEventListener('pointerup', onPointerUp, true);

        const dx = ev.clientX - startX, dy = ev.clientY - startY;
        if (Math.hypot(dx, dy) > 12) return;

        const upEl = document.elementFromPoint(ev.clientX, ev.clientY);
        const bUp = upEl ? upEl.closest('.balloon') : null;
        if (bUp !== b) return;

        handleBalloonClick(b);
      };

      window.addEventListener('pointerup', onPointerUp, { once: true, capture: true });
    }, { passive: false });

    function handleBalloonClick(b) {
      if (inputLocked) return;
      lockInput();

      // 🔉 v1.1: ensure bgm is at ducked level when a balloon is played
      setBgmVolume(BGM_DUCK, 150);

      playSfx(sPop, 0.9);
      b.classList.add('disabled');

      const wrapRect = balloonsWrap.getBoundingClientRect();
      const r = b.getBoundingClientRect();

      // Freeze balloon position under finger
      b.style.animation = 'none';
      b.style.bottom = '';
      b.style.top = (r.top - wrapRect.top) + 'px';
      b.style.left = (r.left - wrapRect.left) + 'px';
      b.style.position = 'absolute';
      b.style.transform = 'none';
      b.style.zIndex = '4';

      void b.offsetWidth; // reflow
      b.classList.add('scale-pop');

      const ANIM_MS = 700;

      if (playCount === 1) {
        setTimeout(() => {
          resultImg.src = './assets/fail.webp';
          actionButton.innerHTML = `
            <button id="try-again-btn" style="background:none;border:none;padding:0;">
              <img src="./assets/try bt.gif" alt="Try Again" />
            </button>`;
          showPopup();
          playSfx(sLose, 0.9);

          // remove balloon after popup appears
          b.remove();

          if (typeof confetti === 'function') {
            confetti({ particleCount: 40, spread: 80, origin: { y: 0.55 } });
          }

          document.getElementById('try-again-btn').addEventListener('click', () => {
            playSfx(sTry || sPop, 0.9);
            if (typeof fbq === 'function') fbq('trackCustom', 'PlayAgain', { content_name: 'Try Again - Balloon' });
            hidePopup();
            unlockInput(); // allow next click (round 2)
          }, { once: true });
        }, ANIM_MS);

        playCount = 2;
      } else {
        setTimeout(() => {
          resultImg.src = './assets/win20.webp';
          actionButton.innerHTML = `
            <a id="claim-button" href="https://t.me/FAFA558KH" target="_blank" rel="noopener">
              <img src="./assets/claim bt.gif" alt="Claim" />
            </a>`;
          showPopup();
          playSfx(sWin, 0.9);
          celebrateLoop();

          // remove balloon after popup appears
          b.remove();

          const claimBtn = document.getElementById('claim-button');
          if (claimBtn) {
            claimBtn.addEventListener('click', () => {
              playSfx(sClaim || sWin, 0.9);
              if (typeof fbq === 'function') {
                fbq('track', 'Purchase', { value: 2.0, currency: 'USD', content_name: 'Claim Button - Balloon' });
              }
            }, { once: true });
          }
        }, ANIM_MS);
      }
    }

    // Close popup when tapping outside the action area (and unlock input)
    popup.addEventListener('click', (e) => {
      if (!e.target.closest('#actionButton')) {
        hidePopup();
        unlockInput();
      }
    });

    // Keep existing behavior: click outside a/btn inside action area closes popup
    actionButton.addEventListener('click', (e) => {
      const target = e.target.closest('a,button'); if (!target) { hidePopup(); unlockInput(); }
    });
  </script>
</body>
</html>
