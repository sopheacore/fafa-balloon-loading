<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Balloon Loading Game</title>
  <link rel="icon" href="./assets/hot-air-balloon.ico" type="image/x-icon" />

  <!-- âœ… Meta Pixel -->
  <script>
    !(function (f, b, e, v, n, t, s) {
      if (f.fbq) return;
      n = f.fbq = function () {
        n.callMethod ? n.callMethod.apply(n, arguments) : n.queue.push(n);
      };
      if (!f._fbq) f._fbq = n;
      n.push = n; n.loaded = !0; n.version = "2.0"; n.queue = [];
      t = b.createElement(e); t.async = !0; t.src = v;
      s = b.getElementsByTagName(e)[0]; s.parentNode.insertBefore(t, s);
    })(window, document, "script", "https://connect.facebook.net/en_US/fbevents.js");
    fbq("init", "730830449557162");
    fbq("track", "PageView");
  </script>
  <noscript>
    <img height="1" width="1" style="display:none"
         src="https://www.facebook.com/tr?id=730830449557162&ev=PageView&noscript=1"/>
  </noscript>

  <style>
    :root { --vh: 100vh; }
    *{box-sizing:border-box}
    html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #000; }
    .landing { position: relative; width: 100vw; height: 100vh; overflow: hidden; -webkit-tap-highlight-color: transparent; }
    .landing-bg { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: contain; z-index: 0; }

    .headline { position: absolute; top: 4%; left: 50%; transform: translateX(-50%); z-index: 2; text-align:center; }
    .headline img { width: 72vw; max-width: 420px; height: auto; }

    .balloons {
      position: absolute; left: 50%; top: 55%; transform: translate(-50%, -50%);
      display: grid; grid-template-columns: repeat(4, min(22vw, 140px)); gap: min(4vw, 16px);
      z-index: 2; width: 92vw; max-width: 680px; justify-content: center; align-items: end;
      touch-action: manipulation; /* âœ… better touch */
    }

    .balloon {
      position: relative;
      width: clamp(72px, 20vw, 250px);
      height: clamp(72px, 20vw, 250px);
      background: center/contain no-repeat;
      filter: drop-shadow(0 6px 12px rgba(0,0,0,.25));
      cursor: pointer; transition: transform .22s ease;
      transform-origin: center center;
      -webkit-touch-callout: none; user-select: none;
    }

    /* âœ… Invisible hitbox for easier taps on mobile (about 1.6Ã— area) */
    .balloon::before{
      content:""; position:absolute; inset: -18%;
      /* Bigger clickable area without changing visual size */
    }

    .balloon::after {
      content: ""; position: absolute; left: 50%; bottom: -14px; transform: translateX(-50%);
      width: 50%; height: 10px; background: radial-gradient(ellipse at center, rgba(0,0,0,.35), rgba(0,0,0,0));
      filter: blur(2px); pointer-events: none;
    }

    /* âœ… Only show hover raise on devices that have hover (won't fight touch) */
    @media (hover:hover) and (pointer:fine){
      .balloon:hover { transform: translateY(-4px) scale(1.03); }
    }

    .balloon.disabled { pointer-events: none; }

    /* Free-fly mode */
    .balloons.free-fly {
      position: absolute; inset: 0; transform: none; width: 100%; max-width: none;
      display: block;
    }
    .balloons.free-fly .balloon {
      position: absolute;
      left: var(--x, 10%);
      bottom: -20vh;
      animation-name: riseLoopDecel;
      animation-duration: var(--speed, 12s);
      animation-timing-function: linear;
      animation-iteration-count: infinite;
      animation-delay: var(--delay, 0s);
    }

    .play-button { position: absolute; left: 50%; transform: translateX(-50%); bottom: 22px; z-index: 2; display:none; }
    .play-button img, .action-button img { width: 320px; max-width: 82vw; height: auto; }

    .popup {
      position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center;
      background: rgba(0,0,0,.68); z-index: 3; opacity: 0; transform: scale(.9); pointer-events: none;
      -webkit-backdrop-filter: blur(2px); backdrop-filter: blur(2px);
    }
    .popup.show { pointer-events: auto; animation: popupIn .8s ease forwards; }
    .result { width: 360px; max-width: 92vw; margin-bottom: 14px; }
    .action-button { margin-top: 14px; }

    @keyframes popupIn { 0%{transform:scale(.9);opacity:0} 50%{transform:scale(1.05);opacity:1} 100%{transform:scale(1);opacity:1} }

    @keyframes riseLoopDecel {
      0%   { transform: translateY(0) scale(1); opacity: 0; }
      5%   { opacity: 1; }
      20%  { transform: translateY(-70vh) scale(1); }
      60%  { transform: translateY(-105vh) scale(1); }
      100% { transform: translateY(-120vh) scale(1); opacity: 1; }
    }

    .balloon.scale-pop {
      animation: scalePop 0.7s ease-out forwards;
      z-index: 4;
    }
    @keyframes scalePop {
      0%   { transform: scale(1);   opacity: 1; }
      100% { transform: scale(4);   opacity: 1; }
    }

    @media (max-height: 560px){ .balloons{ top:50%; } }

    /* Bigger balloons on mobile / Telegram webview */
	@media (max-width: 600px) {
	  .balloon {
	    width:  clamp(120px, 24vw, 275px);
	    height: clamp(120px, 24vw, 275px);
	  }
	  /* Make the grid cells match the bigger balloons (seen briefly at load) */
	  .balloons {
	    grid-template-columns: repeat(4, clamp(90px, 24vw, 175px));
	  }
	}


  </style>
</head>
<body>
  <div class="landing">
    <img class="landing-bg" src="./assets/BGnew.webp" alt="Background" />

    <!-- ðŸŽˆ Balloons -->
    <div class="balloons" id="balloons">
      <div class="balloon" style="background-image:url('./assets/B1.gif')" aria-label="balloon"></div>
      <div class="balloon" style="background-image:url('./assets/B2.gif')" aria-label="balloon"></div>
      <div class="balloon" style="background-image:url('./assets/B3.gif')" aria-label="balloon"></div>
      <div class="balloon" style="background-image:url('./assets/B1.gif')" aria-label="balloon"></div>
    </div>

    <!-- â–¶ï¸ Play CTA (kept but hidden) -->
    <div class="play-button"><img id="play-button" src="./assets/play bt.gif" alt="Play Now" /></div>

    <!-- ðŸ”” Popup -->
    <div class="popup" id="popup">
      <img class="result" id="resultImg" src="" alt="Result" />
      <div class="action-button" id="actionButton"></div>
    </div>
  </div>

  <!-- ðŸ”Š SFX (replace with your actual files) -->
  <audio id="sfx-pop"  src="./assets/sfx/pop.mp3"  preload="auto"></audio>
  <audio id="sfx-win"  src="./assets/sfx/win.mp3"  preload="auto"></audio>
  <audio id="sfx-lose" src="./assets/sfx/lose.mp3" preload="auto"></audio>

  <!-- ðŸŽ‰ Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

  <script>
    const balloonsWrap = document.getElementById('balloons');
    const playBtn = document.getElementById('play-button');
    const popup = document.getElementById('popup');
    const resultImg = document.getElementById('resultImg');
    const actionButton = document.getElementById('actionButton');

    // ðŸ”Š Audio helpers
    const sPop  = document.getElementById('sfx-pop');
    const sWin  = document.getElementById('sfx-win');
    const sLose = document.getElementById('sfx-lose');

    // make a safe play function that restarts sound and ignores errors
    function playSfx(audioEl, volume = 1) {
      if (!audioEl) return;
      try {
        audioEl.pause();
        audioEl.currentTime = 0;
        audioEl.volume = volume;
        audioEl.play().catch(()=>{ /* autoplay might block until first gesture */ });
      } catch(e){}
    }

    // ensure first gesture unlocks audio on iOS/Android
    let audioUnlocked = false;
    function unlockAudioOnce() {
      if (audioUnlocked) return;
      audioUnlocked = true;
      // Try playing a very short, silent-ish sound (or the pop quietly)
      playSfx(sPop, 0.001);
      setTimeout(()=>{ try{ sPop.pause(); sPop.currentTime = 0; }catch(e){} }, 80);
    }
    window.addEventListener('pointerdown', unlockAudioOnce, { once:true, passive:true });

    // Start with 1 so first tap = attempt one
    let playCount = 1;

    function showPopup() {
      popup.style.display = 'flex';
      requestAnimationFrame(() => popup.classList.add('show'));
    }
    function hidePopup() {
      popup.classList.remove('show');
      setTimeout(() => (popup.style.display = 'none'), 300);
    }
    function celebrateLoop() {
      let go = true;
      (function fire() {
        if (!go) return;
        if (typeof confetti === 'function') {
          confetti({ particleCount: 70, spread: 360, startVelocity: 42, ticks: 80, origin: { y: 0.55 } });
        }
        setTimeout(fire, 1800);
      })();
      actionButton.addEventListener('click', () => go = false, { once: true });
    }

    /* Randomize helpers for free-fly mode */
    function seedBalloon(b) {
      const x = Math.random() * 80 + 10;                  // 10%..90%
      const speed = (Math.random() * 6 + 9).toFixed(2) + 's'; // 9s..15s
      const delay = (Math.random() * 3).toFixed(2) + 's';  // 0..3s
      b.style.setProperty('--x', x + '%');
      b.style.setProperty('--speed', speed);
      b.style.setProperty('--delay', delay);
    }
    function startFreeFly() {
      balloonsWrap.classList.add('free-fly');
      Array.from(balloonsWrap.querySelectorAll('.balloon')).forEach(b => {
        seedBalloon(b);
        b.addEventListener('animationiteration', () => {
          const x = Math.random() * 80 + 10;
          b.style.setProperty('--x', x + '%');
        }, { passive: true });
      });
    }

    // ðŸ” AUTOSTART on load
    window.addEventListener('DOMContentLoaded', () => {
      if (playBtn) playBtn.style.display = 'none';
      startFreeFly();
      if (typeof fbq === 'function') {
        fbq('trackCustom', 'Play', { content_name: 'Auto Start - Balloon' });
      }
    }, { passive:true });

    // Use pointer events for best cross-device behavior
    balloonsWrap.addEventListener('pointerdown', (e) => {
      const b = e.target.closest('.balloon');
      if (!b) return;
      if (b.classList.contains('disabled')) return;

      // ðŸ”Š pop immediately on touch/click
      playSfx(sPop, 0.9);

      // Prevent double taps on same balloon
      b.classList.add('disabled');

      // Freeze balloon where it is now
      const wrapRect = balloonsWrap.getBoundingClientRect();
      const r = b.getBoundingClientRect();

      // Stop the looping rise immediately
      b.style.animation = 'none';

      // Convert to absolute coordinates within the wrapper
      b.style.bottom = '';
      b.style.top = (r.top - wrapRect.top) + 'px';
      b.style.left = (r.left - wrapRect.left) + 'px';
      b.style.position = 'absolute';
      b.style.transform = 'none';
      b.style.zIndex = '4';

      // Force reflow so the next animation starts cleanly
      void b.offsetWidth;

      // Scale in place from 1Ã— â†’ 4Ã—
      b.classList.add('scale-pop');

      const ANIM_MS = 700;

      // After the scale finishes, remove the balloon from DOM
      const removeAfterScale = () => {
        b.removeEventListener('animationend', removeAfterScale);
        b.remove();
      };
      b.addEventListener('animationend', removeAfterScale, { once: true });

      // Show outcome + ðŸ”Š SFX
      if (playCount === 1) {
        setTimeout(() => {
          resultImg.src = './assets/fail.webp';
          actionButton.innerHTML = `
            <button id="try-again-btn" style="background:none;border:none;padding:0;">
              <img src="./assets/try bt.gif" alt="Try Again" />
            </button>`;
          showPopup();
          playSfx(sLose, 0.9); // lose sound
          if (typeof confetti === 'function') {
            confetti({ particleCount: 40, spread: 80, origin: { y: 0.55 } });
          }
          document.getElementById('try-again-btn').addEventListener('click', () => {
            if (typeof fbq === 'function') {
              fbq('trackCustom', 'PlayAgain', { content_name: 'Try Again - Balloon' });
            }
            hidePopup();
          }, { once: true });
        }, ANIM_MS);
        playCount = 2;
      } else if (playCount === 2) {
        setTimeout(() => {
          resultImg.src = './assets/win20.webp';
          actionButton.innerHTML = `
            <a id="claim-button" href="https://t.me/m/8efXjOmkY2U9" target="_blank" rel="noopener">
              <img src="./assets/claim bt.gif" alt="Claim" />
            </a>`;
          showPopup();
          playSfx(sWin, 0.9); // win sound
          celebrateLoop();
          const claimBtn = document.getElementById('claim-button');
          if (claimBtn) {
            claimBtn.addEventListener('click', () => {
              if (typeof fbq === 'function') {
                fbq('track', 'Purchase', { value: 2.0, currency: 'USD', content_name: 'Claim Button - Balloon' });
              }
            }, { once: true });
          }
        }, ANIM_MS);
      }
    }, { passive: true });

    // Close popup if user taps outside explicit buttons (fallback)
    actionButton.addEventListener('click', (e) => {
      const target = e.target.closest('a,button');
      if (!target) hidePopup();
    });
  </script>
</body>
</html>
