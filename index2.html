<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Balloon Loading Game</title>
  <link rel="icon" href="./assets/hot-air-balloon.ico" type="image/x-icon" />

  <!-- ‚úÖ Meta Pixel -->
  <script>
    !(function (f, b, e, v, n, t, s) {
      if (f.fbq) return;
      n = f.fbq = function () {
        n.callMethod ? n.callMethod.apply(n, arguments) : n.queue.push(n);
      };
      if (!f._fbq) f._fbq = n;
      n.push = n; n.loaded = !0; n.version = "2.0"; n.queue = [];
      t = b.createElement(e); t.async = !0; t.src = v;
      s = b.getElementsByTagName(e)[0]; s.parentNode.insertBefore(t, s);
    })(window, document, "script", "https://connect.facebook.net/en_US/fbevents.js");
    fbq("init", "730830449557162");
    fbq("track", "PageView");
  </script>
  <noscript>
    <img height="1" width="1" style="display:none"
         src="https://www.facebook.com/tr?id=730830449557162&ev=PageView&noscript=1"/>
  </noscript>

  <style>
    :root { --vh: 100vh; }
    *{box-sizing:border-box}
    html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #000; }
    .landing { position: relative; width: 100vw; height: 100vh; overflow: hidden; }
    .landing-bg { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: contain; z-index: 0; }

    .headline { position: absolute; top: 4%; left: 50%; transform: translateX(-50%); z-index: 2; text-align:center; }
    .headline img { width: 72vw; max-width: 420px; height: auto; }

    /* === Initial: row/grid like your version === */
    .balloons {
      position: absolute; left: 50%; top: 55%; transform: translate(-50%, -50%);
      display: grid; grid-template-columns: repeat(4, min(22vw, 140px)); gap: min(4vw, 16px);
      z-index: 2; width: 92vw; max-width: 680px; justify-content: center; align-items: end;
    }
    .balloon {
      position: relative;
      width: min(22vw, 140px); height: min(22vw, 140px);
      background: center/contain no-repeat;
      filter: drop-shadow(0 6px 12px rgba(0,0,0,.25));
      cursor: pointer; transition: transform .25s ease;
      transform-origin: center center; /* important for in-place scaling */
    }
    .balloon::after {
      content: ""; position: absolute; left: 50%; bottom: -14px; transform: translateX(-50%);
      width: 50%; height: 10px; background: radial-gradient(ellipse at center, rgba(0,0,0,.35), rgba(0,0,0,0));
      filter: blur(2px);
    }
    .balloon:hover { transform: translateY(-4px) scale(1.03); }
    .balloon.disabled { pointer-events: none; }

    /* === After Play: free-fly field with absolute balloons and LOOPING rise === */
    .balloons.free-fly {
      position: absolute; inset: 0; transform: none; width: 100%; max-width: none;
      display: block; /* children will be absolute */
    }
    .balloons.free-fly .balloon {
      position: absolute;
      left: var(--x, 10%);
      bottom: -20vh;
      width: clamp(72px, 18vw, 140px);
      height: clamp(72px, 18vw, 140px);
      /* ‚ñº NEW: decelerating bottom‚Üítop motion (fast‚Üíslow), loops forever */
      animation-name: riseLoopDecel;
      animation-duration: var(--speed, 12s);
      animation-timing-function: linear; /* timing is baked into keyframe spacing */
      animation-iteration-count: infinite;
      animation-delay: var(--delay, 0s);
    }

    .play-button { position: absolute; left: 50%; transform: translateX(-50%); bottom: 22px; z-index: 2; }
    .play-button img, .action-button img { width: 320px; max-width: 82vw; height: auto; }

    .popup {
      position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center;
      background: rgba(0,0,0,.68); z-index: 3; opacity: 0; transform: scale(.9); pointer-events: none;
    }
    .popup.show { pointer-events: auto; animation: popupIn .8s ease forwards; }
    .result { width: 360px; max-width: 92vw; margin-bottom: 14px; }
    .action-button { margin-top: 14px; }

    @keyframes popupIn { 0%{transform:scale(.9);opacity:0} 50%{transform:scale(1.05);opacity:1} 100%{transform:scale(1);opacity:1} }

    /* === NEW: Decelerating loop (roughly ‚Äú10‚Üí8‚Üí6‚Üí2‚Äù speed) ===
       We cover most distance early, then slow down toward the top. */
    @keyframes riseLoopDecel {
      0%   { transform: translateY(0) scale(1); opacity: 0; }
      5%   { opacity: 1; }
      /* fast first segment (cover ~70% height in just 20% time) */
      20%  { transform: translateY(-70vh) scale(1); }
      /* then slow down (next 40% time covers only ~35vh) */
      60%  { transform: translateY(-105vh) scale(1); }
      /* final crawl (last 40% time covers remaining ~15vh) */
      100% { transform: translateY(-120vh) scale(1); opacity: 1; }
    }

    /* === On click: scale from 1√ó ‚Üí 4√ó in place === */
    .balloon.scale-pop {
      animation: scalePop 0.7s ease-out forwards;
      z-index: 4;
    }
    @keyframes scalePop {
      0%   { transform: scale(1);   opacity: 1; }
      100% { transform: scale(4);   opacity: 1; }
    }

    @media (max-height: 560px){ .balloons{ top:50%; } }
  </style>
</head>
<body>
  <div class="landing">
    <img class="landing-bg" src="./assets/BG1.webp" alt="Background" />

    <!-- üéà Balloons (start as a row) -->
    <div class="balloons" id="balloons">
      <div class="balloon" style="background-image:url('./assets/B1.gif')" aria-label="balloon"></div>
      <div class="balloon" style="background-image:url('./assets/B2.gif')" aria-label="balloon"></div>
      <div class="balloon" style="background-image:url('./assets/B3.gif')" aria-label="balloon"></div>
      <div class="balloon" style="background-image:url('./assets/B1.gif')" aria-label="balloon"></div>
    </div>

    <!-- ‚ñ∂Ô∏è Play CTA -->
    <div class="play-button"><img id="play-button" src="./assets/play bt.gif" alt="Play Now" /></div>

    <!-- üîî Popup -->
    <div class="popup" id="popup">
      <img class="result" id="resultImg" src="" alt="Result" />
      <div class="action-button" id="actionButton"></div>
    </div>
  </div>

  <!-- üéâ Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

  <script>
    const balloonsWrap = document.getElementById('balloons');
    const playBtn = document.getElementById('play-button');
    const popup = document.getElementById('popup');
    const resultImg = document.getElementById('resultImg');
    const actionButton = document.getElementById('actionButton');

    let playCount = 0;

    function showPopup() {
      popup.style.display = 'flex';
      requestAnimationFrame(() => popup.classList.add('show'));
    }
    function hidePopup() {
      popup.classList.remove('show');
      setTimeout(() => (popup.style.display = 'none'), 400);
    }
    function celebrateLoop() {
      let go = true;
      (function fire() {
        if (!go) return;
        if (typeof confetti === 'function') {
          confetti({ particleCount: 70, spread: 360, startVelocity: 42, ticks: 80, origin: { y: 0.55 } });
        }
        setTimeout(fire, 1800);
      })();
      actionButton.addEventListener('click', () => go = false, { once: true });
    }

    /* === Randomize helpers for free-fly mode === */
    function seedBalloon(b) {
      const x = Math.random() * 80 + 10;                  // 10%..90%
      const speed = (Math.random() * 6 + 9).toFixed(2) + 's'; // 9s..15s base duration
      const delay = (Math.random() * 3).toFixed(2) + 's';  // 0..3s
      b.style.setProperty('--x', x + '%');
      b.style.setProperty('--speed', speed);
      b.style.setProperty('--delay', delay);
    }
    function startFreeFly() {
      balloonsWrap.classList.add('free-fly');
      // absolute-position & animate existing balloons
      Array.from(balloonsWrap.querySelectorAll('.balloon')).forEach(b => {
        seedBalloon(b);
        // each loop, re-lane horizontally
        b.addEventListener('animationiteration', () => {
          const x = Math.random() * 80 + 10;
          b.style.setProperty('--x', x + '%');
        }, { passive: true });
      });
    }

    playBtn.addEventListener('click', () => {
      if (playCount >= 2) return;
      playCount++;
      playBtn.style.display = 'none';
      startFreeFly();  // switch to absolute + looping mode AFTER Play
      if (typeof fbq === 'function') {
        fbq('trackCustom', 'Play', { content_name: 'Play Button Click - Balloon' });
      }
    });

    // Delegate clicks so newly added/remaining balloons still work after removals
    balloonsWrap.addEventListener('click', (e) => {
      const b = e.target.closest('.balloon');
      if (!b) return;
      if (playCount === 0) return; // ignore clicks before Play
      if (b.classList.contains('disabled')) return;

      // Prevent double clicks on the same balloon
      b.classList.add('disabled');

      // Freeze this balloon exactly where it is now (relative to wrapper)
      const wrapRect = balloonsWrap.getBoundingClientRect();
      const r = b.getBoundingClientRect();

      // Stop the looping rise immediately
      b.style.animation = 'none';

      // Convert to absolute coordinates within the wrapper
      b.style.bottom = '';                               // ensure top takes effect
      b.style.top = (r.top - wrapRect.top) + 'px';
      b.style.left = (r.left - wrapRect.left) + 'px';
      b.style.position = 'absolute';
      b.style.transform = 'none';                        // start scale from 1
      b.style.zIndex = '4';

      // Force reflow so the next animation starts cleanly
      void b.offsetWidth;

      // Scale in place from 1√ó ‚Üí 4√ó
      b.classList.add('scale-pop');

      const ANIM_MS = 700; // match @keyframes scalePop

      // After the scale finishes, remove the balloon from DOM
      const removeAfterScale = () => {
        b.removeEventListener('animationend', removeAfterScale);
        b.remove(); // üî• remove clicked balloon
      };
      b.addEventListener('animationend', removeAfterScale, { once: true });

      // Show outcome
      if (playCount === 1) {
        setTimeout(() => {
          resultImg.src = './assets/fail.webp';
          actionButton.innerHTML = `
            <button id="try-again-btn" style="background:none;border:none;padding:0;">
              <img src="./assets/try bt.gif" alt="Try Again" />
            </button>`;
          showPopup();
          if (typeof confetti === 'function') {
            confetti({ particleCount: 40, spread: 80, origin: { y: 0.55 } });
          }
          document.getElementById('try-again-btn').addEventListener('click', () => {
            if (typeof fbq === 'function') {
              fbq('trackCustom', 'PlayAgain', { content_name: 'Try Again - Balloon' });
            }
          }, { once: true });
        }, ANIM_MS);
      } else if (playCount === 2) {
        setTimeout(() => {
          resultImg.src = './assets/win20.webp';
          actionButton.innerHTML = `
            <a id="claim-button" href="https://t.me/m/8efXjOmkY2U9" target="_blank" rel="noopener">
              <img src="./assets/claim bt.gif" alt="Claim" />
            </a>`;
          showPopup();
          celebrateLoop();
          const claimBtn = document.getElementById('claim-button');
          if (claimBtn) {
            claimBtn.addEventListener('click', () => {
              if (typeof fbq === 'function') {
                fbq('track', 'Purchase', { value: 2.0, currency: 'USD', content_name: 'Claim Button - Balloon' });
              }
            }, { once: true });
          }
        }, ANIM_MS);
      }
    });

    actionButton.addEventListener('click', () => {
      hidePopup();
      if (playCount === 1) {
        // show Play again to start second attempt
        setTimeout(() => playBtn.style.display = 'block', 400);
      }
    });
  </script>
</body>
</html>
